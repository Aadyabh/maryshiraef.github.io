<!DOCTYPE html>
<html>
  <head>
    <title>Policy Map</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/14.0.3/nouislider.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/14.0.3/nouislider.min.js" charset="utf-8"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js" charset="utf-8"></script>
    <!--<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>-->
    <!-- Load CARTO VL JS -->
    <script src="https://libs.cartocdn.com/carto-vl/v1.4.4/carto-vl.js"></script>
    <!-- Load Mapbox GL -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mapbox-gl/1.10.0/mapbox-gl.js"></script>
    <link href="https://api.tiles.mapbox.com/mapbox-gl-js/v0.52.0/mapbox-gl.css" rel="stylesheet"/>
    <!-- Load CARTO VL Styles -->
    <link href="https://carto.com/developers/carto-vl/examples/maps/style.css" rel="stylesheet"/>
    <script src="https://libs.cartocdn.com/airship-components/v1.0.3/airship.js"></script>
    <link rel="stylesheet" href="https://libs.cartocdn.com/airship-style/v1.0.3/airship.css">
    <style>
      #map {
        position: absolute;
        width: 100%;
        height: 100%;
        transition: 0.25s;
        background-color:#222;
      }
      .slider {
          margin: 60px 20px 100px 20px;
          width:50%;
          margin-left: auto;
          margin-right: auto;
          left: 200px;
          right: 284px;
          text-align: center;
          position: absolute;
          color: #fff;
          z-index:10}
      .point-mark{
        height:20px;
        width:20px;
        border:none;
      }
      .label{
        font-size:16px;
      }
      .info {
        position: fixed;
        z-index:10;
        height:100%;
        min-height:100%;
        max-height:100%;
        width:20%;
        max-width:20%;
        background-color:#222;
        margin-right:-20%;
        right:0;
        margin-bottom:0;
        bottom:0;
        transition: 0.25s;
        overflow:scroll;
        overflow-x:hidden;
        color: #aaa;
        font-family: Helvetica,sans-serif;
        }
      .info a:link, a:visited {
        color: white;
      }
      #subinfo {
        border: 1px solid #eee;
        border-radius: 16px;
        position:absolute;
        margin: 10px 10px 10px 10px;
        padding: 5px 15px 5px 15px;
        z-index:10;
        height:95%;
        width:95%;
        max-height:95%;

      }
      #toolbox{
        margin-left:0;
        top:auto;
        left:1%;
        bottom:100px;
        margin-bottom:0;
        max-height:340px;
      }
      .noUi-pips {
          position: absolute;
          color: #fff;
      }
      .mapboxgl-popup-content {
          min-width: 300px;
          max-width: 700px;
      }
      .noUi-horizontal .noUi-handle-lower .noUi-tooltip {
         top: 40px;
         width:80px;
         height: 30px;
         font-family: Helvetica,sans-serif;
      }
      .noUi-value {
        width:60px;
        font-family: Helvetica,sans-serif;
      }
    }
      body {
          background-color:#222;
          font-family: Helvetica, Arial, sans-serif;
      }
    </style>
    </head>
    <body>
      <div class="slider"></div>
      <div id="map"></div>
      <div id="info" class="info"></div>
      <aside class="toolbox" id="toolbox">
        <div class="box">
          <header>
            <h1>Closure type</h1>
          </header>
          <section>
            <div id="controls">
              <p id="content-title"></p>
              <ul id="content"></ul>
            </div>
          </section>
          <as-category-widget class="as-p--16"
              visible-categories="5"
              disable-interactivity/>
          <footer class="js-footer"></footer>
        </div>
      </aside>
      <div id="loader">
        <div class="CDB-LoaderIcon CDB-LoaderIcon--big">
          <svg class="CDB-LoaderIcon-spinner" viewBox="0 0 50 50">
            <circle class="CDB-LoaderIcon-path" cx="25" cy="25" r="20" fill="none"></circle>
          </svg>
        </div>
      </div> 
  </body>
  <script>
    const s = carto.expressions;
    const map = new mapboxgl.Map({
      container: 'map',
      //style: carto.basemaps.darkmatter ,
      style: '/mapstyle.json',
      center: [0, 30],
      pitchWithRotate : false,
      dragRotate: false,
      touchPitch: false,
      minZoom: 2,
      renderWorldCopies: false,
      maxBounds: new mapboxgl.LngLatBounds(
  new mapboxgl.LngLat(-180, -70),
  new mapboxgl.LngLat(180, 80)
),
      maxZoom:6,
      zoom: 2
    })
    carto.setDefaultAuth({
      username: 'maryshiraef',
      apiKey: 'default_public'
    })
    const nav = new mapboxgl.NavigationControl({
      showCompass: false
    });
    map.addControl(nav, 'top-left');
    map.addControl(new mapboxgl.FullscreenControl(), 'top-left');

    const popup = new mapboxgl.Popup({
      closeButton: false,
      closeOnClick: false
    });
    const source = new carto.source.SQL(`
      SELECT * FROM carto2
    `);
    const days   = [31, 29, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
    const months = [0,1,2,3,4,5,6,7,8,9,10,11]
    var monthformat = {'0': '01','1': '02','2': '03','3': '04','4': '05','5': '06','6': '07','7': '08','8': '09','9': '10','10': '11'}
    var monthdisplay = {'0': 'Jan ','1': 'Feb ','2': 'Mar ','3': 'Apr ','4': 'May ','5': 'Jun ','6': 'Jul ','7': 'Aug ','8': 'Sep ','9': 'Oct ','10': 'Nov ','11': 'Dec '}
    var pipFormats = {}
    var pipdisplay = {}
    var pipValues = []
    var currentmonth = 04;
    var currentday = 30;
    if (new Date().getFullYear() == "2020"){
      currentmonth = new Date().getMonth();
      currentday = new Date().getDate();
    }
    const currentdate = monthformat[currentmonth] + String("0" + currentday).slice(-2)
    var iter = 0
    for(var month of months){
      if(month > currentmonth){
        break;
      }
      pipValues.push(iter);
      for(var day = 1; day <= days[month]; day++) {
        if( (month == currentmonth) & (day > currentday)){
          break;
        }
       formatdate = monthformat[month] + String("0" + day).slice(-2);
       pipFormats[iter] = formatdate;
       displaydate = monthdisplay[month] + String("0" + day).slice(-2);
       pipdisplay[iter] = displaydate;
       iter++;
      }
    }
    iter=iter-1
    if (iter - pipValues[pipValues.length-1] >10){
      pipValues.push(iter);
    }
    slider = noUiSlider.create($(".slider")[0], {
        //start: [timestamp('2020','01','01'), Date.now()],
        start: iter,
        step: 1,
        snap:false,
        //connect: true,
        orientation: 'horizontal',
        range: {
            'min':[0],
            'max':iter
        },
        tooltips: [{to: function(a){return pipdisplay[parseInt(a)];}}],
        pips: {
        mode: 'values',
        values: pipValues,
        density: 5,
        format: {to: function(a){return pipdisplay[parseInt(a)];}}
        }
    });

    const colormap = {"Border closure" : '#5F4690', "International flights suspension" : '#1D6996', "Visa restrictions":'#0F8554' , "No Policy": '#666666' ,};
    let stringViz = `@country: $country
      @closure_type : $type_${currentdate}
      @note   : $comment_${currentdate}
      @source : $source_${currentdate}
      @histogram : globalHistogram( $type_${currentdate}, 4)`
      for(var month of months){
        if(month > currentmonth){
          break;
        }
        for(var day = 1; day <= days[month]; day++) {
          if( (month == currentmonth) & (day > currentday)){
            break;
          }
          date = monthformat[month] + String("0" + day).slice(-2);
          stringViz = stringViz + `
            @closure_type${date} : $type_${date}
            @note${date}:$comment_${date}
            @source${date}:$source_${date}
            @histogram${date}: globalHistogram( $type_${date}, 4)
            `
        }
      }
    stringViz = stringViz + `
      color: ramp(buckets(@closure_type, ["Border closure", "International flights suspension", "Visa restrictions", "No Policy",]),[#5F4690, #1D6996, #38A6A5, #0F8554,#666666])
      strokeColor: rgba(0,0,0,0.2)
      strokeWidth: 1  `
    const viz = new carto.Viz(stringViz);
    const layer = new carto.Layer('layer', source, viz)
    //#5F4690,#1D6996,#38A6A5,#0F8554,#73AF48,#EDAD08,#E17C05,#CC503E,#94346E,#6F4070,#994E95,#666666
    layer.addTo(map,'watername_ocean');
    const interactivity =new carto.Interactivity(layer);
    interactivity.on('featureClick', updateInfo); 
    let categories = ["Border closure", "International flights suspension", "No Policy","Visa restrictions"];

    function drawHistogram() {
        var histogramWidget = document.querySelector('as-category-widget');
        histogramWidget.categories = viz.variables.histogram.value.map(function(entry) {
          return {
            name: entry.x,
            value: entry.y,
            color: colormap[entry.x]
          }
        });
    }
    layer.on('loaded', () => {
      drawHistogram();
      hideLoader();  
      generateLegend(); 
      setupWidget();
    });

    function generateLegend() {
        // Request data for legend from the layer viz
        const legend = layer.viz.color.getLegendData();
        // Create list elements for legend
        const legendList  = legend.data.map((legend, index) => {
        const color   = rgbToHex(legend.value);
        const key     = legend.key.toLowerCase().replace(' ', '-');
        const checked = categories.includes(legend.key);
        return `
          <li>
            <input
              id="js-checkbox-${key}"
              class="js-checkbox"
              type="checkbox"
              name="categories"
              category="${legend.key}"
            checked>
            <span class="point-mark" style="background-color:${color};"></span>
            <label for="js-checkbox-${key}">${legend.key}</label>
          </li>\n`;
        }).join('');
        document.getElementById('content').innerHTML = legendList;
    }

    function setupWidget() {
      const checkboxes = document.getElementsByClassName('js-checkbox');
      for (let i in checkboxes) {
        const checkbox = checkboxes.item(i);
        checkbox.addEventListener('change', toggleCategory);
      };
    }

    function toggleCategory(event) {
      const checkboxElement = event.currentTarget;
      const category = checkboxElement.getAttribute('category');
      categories = _toggle(categories, category);
      checkboxElement.checked = categories.includes(category);
      // 5. Update the filter
      viz.filter.blendTo(s.in(s.prop('type_'+pipFormats[parseInt(slider.get())]), categories));
      drawHistogram();
    }
    // A function to toggle an element in an array
    function _toggle(arr, item) {
        return arr.includes(item) ? arr.filter(i => i !== item) : [...arr, item];
    }
    function rgbToHex(color) {
      return "#" + ((1 << 24) + (color.r << 16) + (color.g << 8) + color.b).toString(16).slice(1);
    }

    function updatePopup(event) {
      if (event.features.length > 0) {
        const vars = event.features[0].variables;
        popup.setHTML(`
          <div class="CDB-infowindow CDB-infowindow--dark js-infowindow">
            <div class="CDB-infowindow-close js-close"></div>
            <div class="CDB-infowindow-container">
              <div class="CDB-infowindow-header CDB-infowindow-headerBg CDB-infowindow-headerBg--light js-header" style="background: #35AAE5;">      
                <ul class="CDB-infowindow-list">
                  <li class="CDB-infowindow-listItem">
                    <h5 class="CDB-infowindow-subtitle">Country</h5>
                    <h4 class="CDB-infowindow-title ">
                      ${vars.country.value}
                    </h4>
                  </li>
                </ul>
              </div>
              <div class="CDB-infowindow-inner js-inner">
                <ul class="CDB-infowindow-list js-content">
                  <li class="CDB-infowindow-listItem">
                    <h5 class="CDB-infowindow-subtitle">Closure Type</h5>
                    <h4 class="CDB-infowindow-title">${vars.closure_type.value}</h4>
                  </li>
                   <li class="CDB-infowindow-listItem">
                    <h4 class="CDB-infowindow-subtitle">Source:</h4>
                    <h5 class="CDB-infowindow-title"><a href="${vars.source.value}" target="_blank" rel="noopener noreferrer" > ${vars.source.value}</a></h5>
                  </li>
                  <li class="CDB-infowindow-listItem">
                    <h5 class="CDB-infowindow-subtitle">Notes:</h5>
                    <h4 class="CDB-infowindow-title">${vars.note.value}</h4>
                  </li>
                </ul>
              </div>
              <div class="CDB-hook">
              <div class="CDB-hook-inner"></div>
              </div>
            </div>
          </div>
        `);
        popup.setLngLat([event.coordinates.lng, event.coordinates.lat]);
          if (!popup.isOpen()) {
            popup.addTo(map);
          }
      } else {
          popup.remove();
        }
    }
    //range slider update function
    function debounce (func, wait, immediate) {
      var timeout;
      return function() {
        var context = this, args = arguments;
        var later = function() {
          timeout = null;
          if (!immediate) func.apply(context, args);
        };
        var callNow = immediate && !timeout;
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
        if (callNow) func.apply(context, args);
      };
    }

    slider.on('update', debounce(onSlide, 10)); 

    //slider.on('update', function(values,handle){
    function onSlide (values,handle) {
      showdate = pipFormats[parseInt(values[0])]
      popup.remove();
      viz.variables['source']       = viz.variables['source'+pipFormats[parseInt(values[0])]]
      viz.variables['note']         = viz.variables['note'+pipFormats[parseInt(values[0])]]
      //checkAll()
      if(categories.length <= 3){
        //categories = ["Border closure", "International flights suspension", "No Policy","Visa restrictions"];
        //viz.variables['histogram']    = 'globalHistogram( $type_'+pipFormats[parseInt(values[0])]+', 4)'
        viz.filter.blendTo(s.in(s.prop('type_'+pipFormats[parseInt(slider.get())]), categories));
        viz.variables['histogram']    = viz.variables['histogram'+pipFormats[parseInt(values[0])]]
        //FIXME how to filter here?
        //viz.variables['closure_type'] = s.in(s.prop('type_'+pipFormats[parseInt(slider.get())]), categories)
      }
      else{
        viz.variables['histogram']    = viz.variables['histogram'+pipFormats[parseInt(values[0])]]
        viz.variables['closure_type'] = viz.variables['closure_type'+pipFormats[parseInt(values[0])]]
      }
      drawHistogram()
      //Not sure how to update info of country already displayed
      hideInfo()
      //update text on screen
      //$(".values").text("Show area with a population between " + parseInt(values[0]) + " and " + parseInt(values[1]) + " inhabitants");
    };
   // $(slider).trigger("update"); 

  function checkAll(){
    var items=document.getElementsByName('categories');
    for(var i=0; i<items.length; i++){
      if(items[i].type=='checkbox')
        items[i].checked=true;
    }
  }

  function hideLoader() {
    document.getElementById('loader').style.opacity = '0';
  }

  function hideInfo() {
    document.getElementById('info').style.marginRight = '-20%';
    document.getElementById('map').style.width = '100%';
    //document.getElementById('toolbox').style.marginRight = '0';

  }

  const maptransition = document.getElementById('map');
  maptransition.addEventListener('transitionend', function() {
    map.resize();
  });

  function updateInfo(event) {
      if (event.features.length > 0) {
        const vars = event.features[0].variables;
        document.getElementById('info').innerHTML = `
        <div id="subinfo">
          <h1 class="CDB-infowindow-title ">
            ${vars.country.value}
          </h1>
          <h3 class="CDB-infowindow-subtitle">Closure Type:</h3>
          <h2 class="CDB-infowindow-title">${vars.closure_type.value}</h2>
          <h4 class="CDB-infowindow-subtitle">Source:</h4>
          <h5 class="CDB-infowindow-title"><a href="${vars.source.value}" target="_blank" rel="noopener noreferrer" > ${vars.source.value}</a></h5>
          <h5 class="CDB-infowindow-subtitle">Notes:</h5>
          <h4 class="CDB-infowindow-title">${vars.note.value}</h4>
        </div>
        `;
        document.getElementById('info').style.marginRight = '0';
        document.getElementById('map').style.width = '80%';
        //map.resize()
        

        //document.getElementById('toolbox').style.marginRight = '20%';
        //document.getElementById('toolbox').style.marginBottom = '0';

      } else {
          hideInfo();
        }
    }
  </script>
</html>
