<!DOCTYPE html>
  <html>
    <head>
      <title>Policy Map</title>
      <link href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/8.2.1/nouislider.min.css" rel="stylesheet">
      <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/8.2.1/nouislider.min.js" charset="utf-8"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js" charset="utf-8"></script>
      <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
      <!-- Load CARTO VL JS -->
      <script src="https://libs.cartocdn.com/carto-vl/v1.4.4/carto-vl.js"></script>
      <!-- Load Mapbox GL -->
      <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v0.52.0/mapbox-gl.js"></script>
      <link href="https://api.tiles.mapbox.com/mapbox-gl-js/v0.52.0/mapbox-gl.css" rel="stylesheet"/>
      <!-- Load CARTO VL Styles -->
      <link href="https://carto.com/developers/carto-vl/examples/maps/style.css" rel="stylesheet"/>
      <style>
        #map {
          position: absolute;
          width: 100%;
          height: 100%;
        }
        .slider {
            margin: 20px 20px 100px 20px;
            width:50%;
            margin-left: auto;
            margin-right: auto;}
        .mapboxgl-popup-content {
            min-width: 700px;
            max-width: 700px;

        }
        .noUi-horizontal .noUi-handle-lower .noUi-tooltip {
           top: 40px;
           width:80px;

        }
        .noUi-value {
          width:60px;
        }
        body {
            background-color:#222222;
            font-family: Helvetica, Arial, sans-serif;
        }
      </style>
      </head>
      <body>
        <div class="slider"></div>
        <div id="map"></div>
        <aside class="toolbox">
          <div class="box">
            <header>
              <h1>Closure type</h1>
            </header>
            <section>
              <div id="controls">
                <p id="content-title"></p>
                <ul id="content"></ul>
              </div>
            </section>
            <footer class="js-footer"></footer>
          </div>
        </aside>
        <div id="loader">
          <div class="CDB-LoaderIcon CDB-LoaderIcon--big">
            <svg class="CDB-LoaderIcon-spinner" viewBox="0 0 50 50">
              <circle class="CDB-LoaderIcon-path" cx="25" cy="25" r="20" fill="none"></circle>
            </svg>
          </div>
        </div> 
    </body>
    <script>
      const map = new mapboxgl.Map({
        container: 'map',
        style: carto.basemaps.darkmatter ,
        center: [0, 30],
        zoom: 2
      })
      carto.setDefaultAuth({
        username: 'maryshiraef',
        apiKey: 'default_public'
      })
        
      const nav = new mapboxgl.NavigationControl({
        showCompass: false
      });
      map.addControl(nav, 'top-left');
      map.addControl(new mapboxgl.FullscreenControl(), 'top-left');

      const popup = new mapboxgl.Popup({
        closeButton: false,
        closeOnClick: false
      });

      const source = new carto.source.SQL(`
        SELECT * FROM carto
      `);
      
      var monthper = [1,2,3,4]
      var dayper = ["01","02","03","04","05","06","07","08","09","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29"]
      var monthformat = {'1': '01','2': '02','3': '03','4': '04'}
      var monthdisplay = {'1': 'Jan ','2': 'Feb ','3': 'Mar ','4': 'Apr '}
      var pipFormats = {}
      var iter = 0
      monthper.forEach(function(month){
        dayper.forEach(function(day){
         newdate = monthformat[month] + day;
         pipFormats[iter] = newdate;
         iter++;
       })});
      var pipdisplay = {}
      iter=0
      monthper.forEach(function(month){
        dayper.forEach(function(day){
         newdate = monthdisplay[month] + day;
         pipdisplay[iter] = newdate;
         iter++
       })});
      iter=iter-1
        slider = noUiSlider.create($(".slider")[0], {
                //start: [timestamp('2020','01','01'), Date.now()],
                start: iter,
                step: 1,
                snap:false,
                //connect: true,
                orientation: 'horizontal',
                range: {
                    //min: timestamp('2020','01','01'),
                    'min':[0],
                    'max':iter
                     //max: Date.now()
                },
                tooltips: [{to: function(a){return pipdisplay[parseInt(a)];}}],
                pips: {
                mode: 'count',
                values: 4,
                density: 5,
                format: {to: function(a){return pipdisplay[parseInt(a)];}}
                    //values:   [1,2,3,4]//["Jan 2020", "Feb 2020", "Mar 2020", "Apr 2020"]  
                }
            });
            var dateValues = [
                document.getElementById('event-start'),
                document.getElementById('event-end')
            ];

      let stringViz = `@country: $iso3
        @closure_type : $type_0429
        @note   : $comment_0429
        @source : $source_0429`
        monthper.forEach(function(month){
          dayper.forEach(function(day){
          hidedate = monthformat[month] + day;
            stringViz = stringViz + `
            @closure_type${hidedate} : $type_${hidedate}
            @note${hidedate}:$comment_${hidedate}
            @source${hidedate}:$source_${hidedate} 
        `
                  });});
       stringViz = stringViz + `
        color: ramp(buckets(@closure_type0423, ["Border closure", "International flights suspension", "No Policy","Visa restrictions"]),[#5F4690, #1D6996, #38A6A5, #666666,#0F8554])
        strokeColor: rgba(0,0,0,0.2)
        strokeWidth: 1
      `
      const viz = new carto.Viz(stringViz);

      const layer = new carto.Layer('layer', source, viz)
         //#5F4690,#1D6996,#38A6A5,#0F8554,#73AF48,#EDAD08,#E17C05,#CC503E,#94346E,#6F4070,#994E95,#666666
         layer.addTo(map);
         const interactivity =new carto.Interactivity(layer);
         interactivity.on('featureClick', updatePopup); 
         layer.on('loaded', () => {


      let colorLegendList = '';
      hideLoader();
            
      const colorLegend = layer.viz.color.getLegendData();
      colorLegend.data.forEach((legend, index) => {
      const color = rgbToHex(legend.value);
                  // Style for legend items based on geometry type
      colorLegendList +=`<li><span class="point-mark" style="background-color:${color}; border: 1px solid black;"></span><span>${legend.key}</span></li>\n`; });
      document.getElementById('content').innerHTML = colorLegendList;
    
   
      });

      function rgbToHex(color) {
        return "#" + ((1 << 24) + (color.r << 16) + (color.g << 8) + color.b).toString(16).slice(1);
      }

        function updatePopup(event) {
            if (event.features.length > 0) {
                const vars = event.features[0].variables;
                popup.setHTML(`
                <div class="CDB-infowindow CDB-infowindow--light js-infowindow">
                    <div class="CDB-infowindow-close js-close"></div>
                      <div class="CDB-infowindow-container">
                <div class="CDB-infowindow-header CDB-infowindow-headerBg CDB-infowindow-headerBg--light js-header" style="background: #35AAE5;">
                  
                  <ul class="CDB-infowindow-list">
                    <li class="CDB-infowindow-listItem">
                      <h5 class="CDB-infowindow-subtitle">Country</h5>
                      <h4 class="CDB-infowindow-title ">
                        ${vars.country.value}
                      </h4>
                    </li>
                  </ul>
                </div>
                <div class="CDB-infowindow-inner js-inner">
                  <ul class="CDB-infowindow-list js-content">
                    <li class="CDB-infowindow-listItem">
                      <h5 class="CDB-infowindow-subtitle">Closure Type</h5>
                      <h4 class="CDB-infowindow-title">${vars.closure_type.value}</h4>
                    </li>
                     <li class="CDB-infowindow-listItem">
                      <h5 class="CDB-infowindow-subtitle">Source:</h5>
                      <h4 class="CDB-infowindow-title"><a href="${vars.source.value}" > ${vars.source.value}</a></h4>
                    </li>
                    <li class="CDB-infowindow-listItem">
                      <h5 class="CDB-infowindow-subtitle">Notes:</h5>
                      <h4 class="CDB-infowindow-title">${vars.note.value}</h4>
                    </li>
                  </ul>
                </div>
                <div class="CDB-hook">
                  <div class="CDB-hook-inner"></div>
                </div>
                    </div>
                </div>
                `);
                popup.setLngLat([event.coordinates.lng, event.coordinates.lat]);
                if (!popup.isOpen()) {
                    popup.addTo(map);
                }
            } else {
                popup.remove();
            }
        }
        //range slider update function
        slider.on('update', function(values,handle){
          showdate = pipFormats[parseInt(values[0])]
          popup.remove();
          viz.variables['closure_type'] = viz.variables['closure_type'+pipFormats[parseInt(values[0])]]
          viz.variables['source']       = viz.variables['source'+pipFormats[parseInt(values[0])]]
          viz.variables['note']         = viz.variables['note'+pipFormats[parseInt(values[0])]]
          viz.color.blendTo('ramp(buckets(@closure_type'+pipFormats[parseInt(values[0])]+', ["Border closure", "International flights suspension", "No Policy","Visa restrictions"]),[#5F4690, #1D6996, #38A6A5, #666666,#0F8554])',10);
                /*const colorLegend = layers[parseInt(values[0])].viz.color.getLegendData();
                  colorLegend.data.forEach((legend, index) => {
                const color = rgbToHex(legend.value);
                    // Style for legend items based on geometry type
                colorLegendList +=`<li><span class="point-mark" style="background-color:${color}; border: 1px solid black;"></span><span>${legend.key}</span></li>\n`; });
                document.getElementById('content').innerHTML = colorLegendList;*/
                //viz.blendTo ( viznew , 500 )
                //viz.variables['val'].blendTo("$"+newdate);
                //viz.variables['val'] = "$"+newdate
                //update text on screen
                //$(".values").text("Show area with a population between " + parseInt(values[0]) + " and " + parseInt(values[1]) + " inhabitants");
        });
        $(slider).trigger("set"); 
            
    function hideLoader() {
      document.getElementById('loader').style.opacity = '0';
    }
    </script>
  </html>
